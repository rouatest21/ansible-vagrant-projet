stages:
  - validate
  - test
  - deploy

variables:
  ANSIBLE_FORCE_COLOR: "true"

# Template pour installer Ansible et SSH
.install_ansible: &install_ansible
  before_script:
    - apt-get update -qq
    - apt-get install -y ansible sshpass curl

# -------------------------------
# Stage 1: Validation de syntaxe
# -------------------------------
validate_syntax:
  stage: validate
  image: ubuntu:22.04
  <<: *install_ansible
  script:
    - echo "Ì¥ç Validation de la syntaxe du playbook..."
    - cd ansible
    - ansible-playbook playbook.yml --syntax-check -i inventory.ini
    - echo "‚úÖ Syntaxe valide!"
  only:
    - main
    - merge_requests

# -------------------------------
# Stage 2: Test dry-run sur Vagrant
# -------------------------------
test_playbook:
  stage: test
  image: ubuntu:22.04
  <<: *install_ansible
  script:
    - echo "Ì∑™ Test d'ex√©cution du playbook (dry-run)..."
    - cd ansible
    - ansible-playbook playbook.yml --check -i inventory.ini -v
    - echo "‚úÖ Test r√©ussi!"
  only:
    - main
    - merge_requests
  allow_failure: true

# -------------------------------
# Stage 3: D√©ploiement r√©el sur Vagrant
# -------------------------------
deploy_apache:
  stage: deploy
  image: ubuntu:22.04
  <<: *install_ansible
  script:
    - echo "Ì∫Ä D√©ploiement d'Apache sur Vagrant..."
    - cd ansible
    - ansible-playbook playbook.yml -i inventory.ini -v
    - echo "‚úÖ Apache install√©!"
  only:
    - main
  when: manual

# -------------------------------
# Stage 4: V√©rification finale
# -------------------------------
verify_apache:
  stage: deploy
  image: ubuntu:22.04
  <<: *install_ansible
  script:
    - echo "Ì¥é V√©rification d'Apache sur Vagrant..."
    - cd ansible
    - sleep 5
    - |
      if curl -s --connect-timeout 5 http://127.0.0.1:80 > /dev/null; then
        echo "‚úÖ Apache r√©pond correctement!"
      else
        echo "‚ùå Apache ne r√©pond pas"
        exit 1
      fi
  only:
    - main
  dependencies:
    - deploy_apache

